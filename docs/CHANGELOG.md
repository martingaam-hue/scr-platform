# Changelog

All notable changes to SCR Platform are documented here.

Format follows [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).
Versioning follows [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

---

## [Unreleased]

---

## [1.0.0] - 2026-03-01

This is the initial production release of SCR Platform — a full-featured SaaS investment intelligence platform connecting impact project developers with professional investors. The release consolidates all sprints from initial build through Sprint 16 and all Phase A–E enhancements.

---

### Added — Core Platform Infrastructure

#### Authentication and Multi-Tenancy
- Clerk RS256 JWT authentication with JWKS caching (1-hour TTL)
- Clerk webhook sync for user lifecycle events (`user.created`, `user.updated`, `user.deleted`) via Svix HMAC verification
- Multi-tenant data isolation: every query scoped to `org_id` via `TenantMiddleware` and `tenant_filter()` helper
- RBAC hierarchy: `viewer < analyst < manager < admin` with cumulative permission inheritance
- `require_permission(action, resource)` FastAPI dependency for endpoint-level access control

#### API Framework
- FastAPI with async SQLAlchemy 2.0 ORM and `AsyncSession` dependency injection
- 7-layer middleware stack: security headers, rate limiting, body size limit, tenant resolution, audit logging, CORS
- Redis sliding-window rate limiting (IP-based, 300 req/min default; org-tier limits for AI endpoints)
- Immutable `AuditLog` table with fire-and-forget writes (separate DB session, does not roll back on business errors)
- OpenAPI docs auto-generated for all endpoints
- Alembic migrations run as one-off ECS task before each deployment (never at container startup)

#### Background Jobs
- Celery 5 with Redis broker, 5-queue topology: `critical`, `webhooks`, `default`, `bulk`, `retention`
- `task_acks_late=True` globally: tasks re-queue automatically on worker crash
- Celery Beat for 24 scheduled tasks covering all operational needs
- Celery Flower for queue monitoring (internal-only)

#### Storage and File Handling
- S3 pre-signed URL pattern: upload/download never passes through the API server
- SHA-256 checksums stored on every document at upload time
- S3 versioning enabled on documents and redacted PDF buckets

---

### Added — Feature Modules (S01–S25)

#### S01 — Signal Score
AI-powered 5-dimension project quality scoring with version history.
- Dimensions: `project_viability_score`, `financial_planning_score`, `risk_assessment_score`, `team_strength_score`, `esg_score`
- Scoring dispatched to Celery `critical` queue; result stored with full version history
- Score explainability: "What Changed?" timeline comparing dimension deltas between versions
- Badge and quest evaluation triggered on score completion
- Backtesting accuracy metrics (AUC-ROC, precision/recall) vs deal outcomes

#### S02 — Deal Intelligence
AI deal screening, pipeline management, and investment memos.
- AI screening report generated per project with structured scoring
- 3-tab UI: Pipeline / Discover / Compare
- Investment memo generation from screening output
- Pre-loading of cached `deal_relevance` extractions to reduce AI calls

#### S03 — Data Room
Document management with full lifecycle control.
- Document upload with SHA-256 checksum, MIME type validation, and virus scan hook
- Folder hierarchy with access control per folder
- Document versioning with parent/child relationships
- Watermarking support per document
- Classification levels: `PUBLIC`, `CONFIDENTIAL`, `RESTRICTED`, `TOP_SECRET`
- Access log with full audit trail (viewer, download, share actions)
- Document engagement analytics: page view tracking, download monitoring (C02)

#### S04 — Portfolio
Portfolio monitoring and fund management.
- Portfolio holdings linked to projects
- NAV tracking with metric snapshots
- Covenant management with breach and warning detection, automated notifications (C03)
- Cashflow pacing with J-curve projections and draw/distribution modeling (C06)

#### S05 — Matching
AI-powered project-investor matching.
- Compatibility scoring based on investment thesis, geography, stage, and sector preferences
- Warm introduction workflow via matched network (D02 / S21)
- Investor persona profiles for match calibration

#### S06 — Reporting
LP report generation in multiple formats.
- Quarterly and annual report generation
- Export to PDF, XLSX, and PPTX
- Configurable report templates per org

#### S07 — Risk Assessment
Project risk analysis with AI narrative.
- Risk dimension scoring
- Mitigation recommendations generated by AI
- Risk profile versioning

#### S08 — Legal Document Analysis
AI-assisted legal document review.
- Gap detection for missing clauses
- Template library management
- AI review output with source citations

#### S09 — ESG Analysis
ESG scoring and impact reporting.
- ESG portfolio summary view
- Per-project ESG dimension analysis
- Impact metric tracking

#### S10 — Marketplace
Deal listing and discovery.
- Public deal listings for published projects
- Engagement tracking (views, expressions of interest)
- Smart screener with AI-assisted filtering

#### S11 — Notifications
Real-time event notifications and email digests.
- In-app notification delivery
- Digest email preferences (daily/weekly) stored in `user.preferences["digest"]` JSONB
- `email_digest_enabled` flag for legacy Celery Beat weekly digest task compatibility
- Notification categories with per-user opt-out

#### S12 — Meeting Prep
AI-powered investor meeting preparation.
- Meeting brief generation from project data and investor profile
- Key talking points and anticipated questions
- AI Feedback widget on all generated outputs

#### S13 — Carbon Credits
Carbon methodology and credit management.
- Carbon credit project tracking
- Methodology documentation management
- Credit issuance and retirement records

#### S14 — Valuation
Multi-method valuation engine.
- DCF calculation (deterministic Python, never LLM)
- Comparable company analysis
- Sector benchmark references
- Valuation version history

#### S15 — Certification
Project certification workflow.
- Certification application and status tracking
- Document submission for certification requirements
- Reviewer assignment and approval workflow

#### S16 — Board Advisor
Board advisory features.
- Board advisor profile management
- Advisory engagement tracking
- Meeting record management

#### S17 — Insurance
Insurance quote and policy management (advisory tables).
- POST/GET/DELETE for `/insurance/quotes` and `/insurance/policies`
- Advisory data only; no payment processing
- Dedicated project sub-navigation item

#### S18 — Blockchain Audit
Document integrity anchoring.
- SHA-256 document hashing
- Merkle tree construction for batch anchoring
- Polygon blockchain transaction anchoring
- Immutable audit trail per document

#### S19 — Voice Input
Voice transcription for deal notes.
- Browser-based audio capture
- Transcription via AI provider
- Transcribed text inserted into deal notes

#### S20 — Gamification
Achievement and engagement system.
- XP points awarded for platform actions
- Achievement badges: `info`, `success`, `warning`, `gold` variants
- Quest system with time-boxed objectives
- Badge evaluation triggered on signal score completion and onboarding steps

#### S21 — Warm Intros
Network-based introductions.
- Introduction request workflow
- Mutual connection discovery
- Acceptance and decline tracking

#### S22 — Document Annotations
PDF annotation system.
- Inline PDF viewer with highlight and annotation support
- Comment threads anchored to document regions
- Bookmark management
- Q&A linking from annotations (ties to C01 Q&A workflow)

#### S23 — Development OS
Project development stage tracking.
- Stage milestone tracking
- Development checklist per stage
- Progress visualization

#### S24 — Backtesting
Signal score accuracy analysis.
- Historical signal score vs deal outcome comparison
- AUC-ROC, precision, recall metrics
- Per-dimension accuracy breakdown

#### S25 — Expert Insights
Expert note management with AI enrichment.
- Expert note creation
- AI risk tagging and enrichment
- Note versioning and attribution

---

### Added — Phase A (Wire Infrastructure)

#### Prompt Registry (S34)
- `prompt_templates` table: versioned prompt templates for 16+ AI task types
- `PromptTemplate` model with `task_type`, `version`, `is_active`, `content`, `system_prompt` fields
- Unique constraint on `(task_type, version)`
- All 5 AI modules use registry with try/fallback to hardcoded defaults
- Admin API for CRUD on prompt templates
- Async registry lookup; sync Celery tasks use `asyncio.new_event_loop()` for compatibility

#### Analysis Cache (S35)
- `analysis_extractions` table stores AI extraction results keyed by `(document_id, extraction_type, content_hash)`
- `ExtractionType` enum extended: `QUALITY_ASSESSMENT`, `RISK_FLAGS`, `DEAL_RELEVANCE`, `COMPLETENESS_CHECK`, `KEY_FIGURES`, `ENTITY_EXTRACTION`
- Redis-backed cache layer in `engine.py` via `_get_cached_quality()` sync method
- Estimated 40–60% reduction in redundant AI calls for unchanged documents
- `deal_intelligence/tasks.py` pre-loads cached `deal_relevance` extraction

#### Ralph AI — Conversational Assistant (S36)
- Full conversational AI agent backed by `claude-sonnet-4-20250514`
- Agentic tool-use loop (up to 10 iterations per message)
- RAG context retrieval: `_fetch_rag_context()` injects relevant document excerpts into every message
- Streaming SSE endpoint: `POST /ralph/stream` using `fetch` + `ReadableStream` (not `EventSource`)
- 6 backend endpoints: create conversation, list, detail, delete, message, stream
- Sliding right-panel UI with message thread, tool call indicators, and context-aware suggestions
- Ralph panel toggle wired to topbar icon; `<RalphPanel />` mounted in dashboard layout
- `useRalphStore` Zustand store for panel open/close state

#### AI Feedback (S37)
- `ai_feedback` table: thumbs up/down + optional free-text comment per AI output
- `<AIFeedback>` component added to 7 pages: signal-score, valuations, risk, legal, meeting-prep, investor-signal-score, carbon

#### Task Batcher (S39)
- Bulk document processing queue management
- Configurable batch sizes and concurrency limits
- Progress tracking per batch job

---

### Added — Phase B (Data Moat)

#### Metric Snapshots (B01)
- Daily automated snapshots of all key performance metrics
- `metric_snapshots` table with `org_id`, `metric_type`, `value`, `snapshot_date`
- Nightly Celery Beat task for snapshot generation

#### Benchmark Aggregations (B01)
- Nightly peer comparison computations across orgs (anonymised)
- Percentile rankings per metric dimension

#### Score Explainability (B03)
- "What Changed?" timeline UI comparing signal score versions
- Dimension-level delta with contributing factor attribution

#### Source Citations (B04)
- `[1][2]` style reference citations on all AI-generated outputs
- `citations` table linking AI output sections to source documents and page ranges

#### Data Lineage (B05)
- `lineage` module tracking source chain for all computed values
- Lineage graph queryable per entity

---

### Added — Phase C (Enterprise)

#### Q&A Workflow (C01)
- 3-party question routing: investor → project → investor with manager oversight
- SLA enforcement with configurable response deadlines
- Automated breach alerts via notification system
- Q&A thread linked to document annotations

#### Document Engagement Analytics (C02)
- Page-level view tracking in PDF viewer
- Download event logging with user attribution
- Engagement summary per document for data room owners

#### Covenant Monitoring (C03)
- Automated breach and warning threshold detection
- Notification dispatch on breach or warning
- Covenant history with compliance status timeline

#### Excel Add-in (C04)
- Custom Excel functions for live SCR Platform data
- Installation package and manifest
- API key authentication for add-in requests

#### API Key Management (C04)
- Generate, revoke, and rate-limit API keys per org
- `api_keys` table with hashed key storage, scope restrictions, expiry
- Key usage tracked per request

#### HubSpot CRM Sync (C05)
- OAuth 2.0 flow for HubSpot connection
- Bidirectional sync: contacts, companies, deals
- Rate limit handling: 100 requests/10 seconds
- Sync log with per-record status

#### Cashflow Pacing (C06)
- J-curve projection modeling
- Draw schedule and distribution timeline
- Scenario comparison (base, upside, downside)

---

### Added — Phase D (Competitive Edge)

#### Score Backtesting (D01)
- Historical signal score accuracy vs actual deal outcomes
- AUC-ROC, precision/recall metrics per dimension
- Backtesting results stored in `backtesting_results` table

#### Expert Insights (D02)
- Expert note creation with attribution
- AI enrichment: risk tagging, key theme extraction
- Notes linked to projects and portfolio holdings

#### AI Document Redaction (D03)
- Entity detection pass: identifies PII and sensitive entities
- Human review workflow before redaction is applied
- Clean PDF generation after approved redaction
- `redaction_sessions` table tracking review status and applied redactions

#### Webhooks (D04)
- Event delivery system for 20+ event types across all modules
- HMAC-SHA256 request signing with per-subscription secret
- Exponential backoff retry: 1m → 5m → 30m → 2h → 8h
- Auto-disable after 10 consecutive failures with reason stored
- `webhook_subscriptions` and `webhook_deliveries` tables

#### Bulk Operations (D05)
- Signal score recompute for multiple projects in one request
- Document ZIP download for entire folders or filtered sets
- Bulk operations dispatched to `bulk` Celery queue

#### PDF Viewer (D06)
- Full-featured in-browser PDF viewer
- Highlight and annotation support linked to `document_annotations` table
- Q&A thread linking from highlighted regions
- Bookmark creation and management

---

### Added — Phase E (Growth)

#### Salesforce CRM Sync (E01)
- OAuth 2.0 flow for Salesforce connection
- Bidirectional sync: leads, opportunities, accounts
- Custom field mapping configuration
- Sync log with per-record status

#### External Data Feeds (E02)
- Nightly data refresh from: IRENA (renewable energy), World Bank (development indicators), EU ETS (carbon prices), ECB (exchange rates)
- `external_data` table keyed by `(source, dataset, reference_date)`
- FRED macroeconomics data for valuation benchmarks

#### White-Label Branding (E03)
- Custom logo, primary color, and font per org
- Custom domain support with ACM SSL certificate provisioning
- Custom email sender via Resend with org branding
- `custom_domains` table for domain → org mapping

#### Feature Flags (E04)
- Per-org feature toggle system
- `feature_flags` table with `(org_id, feature_key, is_enabled)` and optional config JSONB
- Admin dashboard for flag management without deployment

#### Playwright End-to-End Tests (E05)
- 5 critical user journey tests:
  1. User login and dashboard load
  2. Project creation and signal score request
  3. Document upload and data room access
  4. Ralph AI conversation flow
  5. Webhook delivery verification

#### Industry Taxonomy (E06)
- Hierarchical industry/sector picker with 3-level depth
- `taxonomy` table with `parent_id` self-referencing hierarchy
- Used in project creation, investor preferences, and matching

#### Financial Model Templates (E06)
- Asset-class-specific assumption templates (solar, wind, storage, infrastructure)
- Templates stored in `financial_templates` table
- Pre-populated assumptions editable per project

---

### Added — Infrastructure

#### AWS Architecture
- ECS Fargate: 8 services — `scr-web`, `scr-api`, `scr-ai-gateway`, `scr-celery-beat`, `scr-celery-critical`, `scr-celery-default`, `scr-celery-bulk`, `scr-celery-webhooks`
- ALB with TLS 1.3, routing `/api/*` to API service and `/*` to web service
- RDS PostgreSQL 16 Multi-AZ with read replica for analytics query routing
- ElastiCache Redis 7 cluster with automatic failover
- CloudFront CDN with WAF: SQLi protection, bot detection, common threat rules
- ACM wildcard SSL with auto-renewal via Route53 DNS validation
- All secrets in AWS Secrets Manager, injected at ECS task start

#### Observability
- Sentry error tracking across all 3 services (web, api, ai-gateway)
- CloudWatch Container Insights for ECS metrics
- Structured logging via `structlog` in API and AI Gateway
- CloudWatch log groups: 14-day retention on staging, 90-day on production

#### Security
- Org-aware rate limiting: IP-based (300 req/min) + JWT `org_id` dual-layer enforcement
- Per-org AI budget enforcement with tier defaults (Foundation/Professional/Enterprise)
- Request body size limit: 50 MB hard cap
- Security headers middleware: `X-Content-Type-Options`, `X-Frame-Options`, `Strict-Transport-Security`, `Content-Security-Policy`
- Connector OAuth tokens encrypted at rest using Fernet symmetric encryption

#### Performance
- 7 composite database indexes for query performance on high-traffic columns
- Redis AI result caching keyed by input content hash
- React Query with 5-minute stale time and 10-minute GC on frontend
- JWKS cached in-process for 3,600 seconds

#### Data Management
- Daily `pg_dump` backups to S3 (`scr-production-backups`), Glacier archival after 90 days
- RDS automated backups: 14-day retention with point-in-time recovery to any second
- Data retention policies for 6 high-growth tables (see `apps/api/app/tasks/data_retention.py`)

#### Database Migrations
- 113 tables across 50+ Alembic migration revisions
- Key fix: advisory module enum columns use `_lc_enum()` helper for lowercase PostgreSQL binding
- Migration `aa1122334455`: adds `is_deleted` soft-delete column to 9 advisory tables
- Migration `f1a2b3c4d5e6`: extends `ExtractionType` enum with 6 new values

---

### Fixed

- **Advisory enum binding**: SQLAlchemy 2.0 `Mapped[Enum]` defaults to binding by `.name` (uppercase). Advisory tables were migrated with lowercase enum labels. Fixed by `_lc_enum()` helper in `apps/api/app/models/advisory.py` applying `values_callable=lambda x: [e.value for e in x]` to all advisory enum columns.
- **Signal Score field names**: `SignalScore` dimension fields corrected to `project_viability_score`, `financial_planning_score`, `risk_assessment_score`, `team_strength_score`, `esg_score` (were incorrectly named `technical_score`, `financial_score`, `regulatory_score`, `team_score` in early development).
- **Ralph AI RAG**: `_fetch_rag_context()` added to `apps/api/app/modules/ralph_ai/agent.py`; both `process_message` and `stream` paths now pass document context to the LLM.
- **Gamification triggers**: `evaluate_badges` and `generate_quests` wired into `signal_score/tasks.py` and `onboarding/service.py` — were implemented but not called.
- **Digest preferences**: `PUT /digest/preferences` now correctly updates both `user.preferences["digest"]` JSONB and the `email_digest_enabled` boolean for Celery Beat task compatibility.
- **selectinload refresh**: Added `.execution_options(populate_existing=True)` to `selectinload` queries that run after `db.flush()` to correctly reload server-set fields.

---

## [0.x.x] - 2025

Internal development and sprint iterations. Not released to production. Detailed sprint history available in internal sprint retrospective documents.

---

[Unreleased]: https://github.com/scr-platform/scr-platform/compare/v1.0.0...HEAD
[1.0.0]: https://github.com/scr-platform/scr-platform/releases/tag/v1.0.0
